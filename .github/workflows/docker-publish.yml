name: 构建并推送 Docker 镜像到 Docker Hub

on:
  # 推送到 main 分支时发布 latest + sha 标签
  push:
    branches:
      - main
    # 推送语义化 tag（例如 v0.1.0 或 0.1.0）时发布对应 tag 标签
    tags:
      - "v*.*.*"
      - "*.*.*"
  # 允许手动触发（便于回填或验证）
  workflow_dispatch:

concurrency:
  # 同一分支/同一 tag 串行发布（排队执行），避免并发 push 导致镜像标签互相覆盖
  group: docker-publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      # 创建 GitHub Release 需要写权限（最小权限：contents: write）
      contents: write

    env:
      # Docker Hub 镜像名（仓库名：chouann/naverdictmcp）
      IMAGE_NAME: chouann/naverdictmcp

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 设置 QEMU（用于多架构构建）
        uses: docker/setup-qemu-action@v3

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录 Docker Hub
        # 需要在 GitHub 仓库 Secrets 配置：
        # - DOCKERHUB_USERNAME：Docker Hub 用户名
        # - DOCKERHUB_TOKEN：Docker Hub Access Token（推荐）
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 生成镜像元数据（标签/注解）
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            # 默认分支（main）推送时发布 latest
            type=raw,value=latest,enable={{is_default_branch}}
            # 同步发布短 SHA 标签，便于定位到具体提交
            type=sha,format=short,prefix=sha-
            # tag 推送时，直接使用 tag 名作为镜像 tag（例如 v0.1.0）
            type=ref,event=tag

      - name: 构建并推送（多架构）
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 使用 GitHub Actions 内置缓存加速后续构建
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 创建 GitHub Release
        # 仅在 tag 发布时创建 Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          # 默认值就是 github.ref_name，这里显式指定，方便阅读/维护
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true


